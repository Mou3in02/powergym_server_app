{% extends 'base_dashboard.html.twig' %}

{% block title %}Power GYM | Dashboard{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}

    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Tableau de bord</h1>
                    </div>
                </div>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                <!-- Petites box du haut -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3>{{ nbPersonnes }}</h3>
                                <p>Nombre des clients</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-bag"></i>
                            </div>
                            <a href="{{ path('pers_person_index') }}" class="small-box-footer">
                                Plus info <i class="fas fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>

                    {% if is_granted('ROLE_SUPER_ADMIN') %}
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <h3>{{ nbAdmin }}</h3>
                                    <p>Nombre des administrateurs</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                                <a href="{{ path('dashboard_admin_index') }}" class="small-box-footer">
                                    Plus info <i class="fas fa-arrow-circle-right"></i>
                                </a>
                            </div>
                        </div>
                    {% endif %}

                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3>{{ nbSeance }}</h3>
                                <p>Séance individuelle pour aujourd'hui</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-person-add"></i>
                            </div>
                            <a href="{{ path('pers_session_index') }}" class="small-box-footer">
                                Plus info <i class="fas fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>

                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3>{{ nbAccessToday }}</h3>
                                <p>Client entré aujourd'hui</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-pie-graph"></i>
                            </div>
                            <a href="{{ path('pers_person_index') }}" class="small-box-footer">
                                Plus info <i class="fas fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card card-danger">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="col-6 d-flex justify-content-start">
                                    <h3 class="card-title mb-0">Abonnement actuel par semaine</h3>
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                    <span id="selected_week"></span>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="weakly_bar_chart"
                                        style="min-height: 250px; height: 250px; max-height: 400px; max-width: 100%; width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script>
        const days = [
            "Lundi",
            "Mardi",
            "Mercredi",
            "Jeudi",
            "Vendredi",
            "Samedi",
            "Dimanche"
        ];

        const ctxWeekly = document.getElementById('weakly_bar_chart').getContext('2d');
        const weeklyChart = new Chart(ctxWeekly, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Nombre d\'abonnement',
                    data: [],
                    backgroundColor: 'rgba(220,53,69,0.9)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { ticks: { precision: 0 } }
                },
                plugins: {
                    legend: { display: true },
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'top',
                        formatter: function (value) { return value > 0 ? value : ''; },
                        font: { weight: 'bold', size: 12 }
                    }
                }
            }
        });

        fetch('/dashboard/weekly-data')
            .then(response => response.json())
            .then(data => {
                weeklyChart.data.datasets[0].data = data;
                weeklyChart.update();
            })
            .catch(error => console.error('Erreur lors du chargement des données hebdomadaires:', error));

    </script>
{% endblock %}
